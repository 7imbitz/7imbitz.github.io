<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <title>7imbitz' Blog</title>
</head>
<body>
    <nav class="navbar navbar-dark navbar-expand-lg bg-dark ">
        <div class="container-fluid">
            <div class="mx-4">
                <a class="navbar-brand" href="/index.html">7imbitz's Blog</a>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/docs/aboutMe.html">About Me</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/docs/writings.html">Writings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Programmings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">OSCP Notes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/docs/nDay.html">N-Day Analysis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container my-4 ">
        <div class="row justify-content-center">
            <h1>Analysis of CVE-2023-25157</h1>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-header.png" alt="Diagram">

            <h3>Introduction</h3>
            <p>Maintaining vigilance in the face of emerging threats is essential in the constantly changing cybersecurity landscape. Today, we shed light on CVE-2023-25157, a critical vulnerability that requests prompt consideration. This blog entry intends to give an exhaustive examination of the weakness, its expected effect, and significant moderation procedures.</p>

            <h3>Vendor/Product description</h3>
            <p>GeoServer is an open-source server-side software that allows users to share and publish geospatial data and services over the web. Designed for interoperability, it publishes data from any major spatial data source using open standards.</p>
            <p><strong>Source:</strong> <a href="https://github.com/geoserver/geoserver" target="_blank">https://github.com/geoserver/geoserver</a></p>

            <h3>Vulnerability Overview</h3>
            <p>GeoServer includes support for the OGC Filter expression language and the OGC Common Query Language (CQL) as part of the Web Feature Service (WFS) and Web Map Service (WMS) protocols. CQL is also supported through the Web Coverage Service (WCS) protocol for ImageMosaic coverages.</p>
            <p>In the version prior to 2.22.1 and 2.21.4, there is a SQL injection issue that was found in the filter and function expressions defined by the Open Geospatial Consortium (OGC) standards.</p>
            <ul>
                <li><code>PropertyIsLike</code> filter, when used with a String field and any database DataStore, or with a PostGIS DataStore with encode functions enabled</li>
                <li><code>strEndsWith</code> function, when used with a PostGIS DataStore with encode functions enabled</li>
                <li><code>strStartsWith</code> function, when used with a PostGIS DataStore with encode functions enabled</li>
                <li><code>FeatureId</code> filter, when used with any database table having a String primary key column and when prepared statements are disabled</li>
                <li><code>jsonArrayContains</code> function, when used with a String or JSON field and with a PostGIS or Oracle DataStore (GeoServer 2.22.0+ only)</li>
                <li><code>DWithin</code> filter, when used with an Oracle DataStore</li>
            </ul>
            <p>By combining the vulnerable CQL_Filter, Feature and properties, a user can gain SQL Injection via WFS service.</p>

            <h3>Technical Details</h3>
            <p>--TODO--</p>

            <h3>Proof of Concept</h3>
            <p>For the demonstration, we can set up our own instance of vulnerable GeoServer. And for this case, we'll be using version 2.21.4 via <a href="https://github.com/geoserver/docker" target="_blank">docker</a>. After setting up the vulnerable instance, the URL will be <code>http://<IP>/geoserver/index.html</code>. But the focus of our exploitation was in the WFS service, hence we can head to the URL <code>http://<IP>/geoserver/ows?service=wfs&version=1.0.0&request=GetCapabilities</code> OR by clicking the WFS `1.0.0` under services capabilities in the index.html page.</p>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-demo.png" alt="WFS Service Capabilities">
            <p>We need to first find the <code>&lt;FeatureType&gt;&lt;Name&gt;data&lt;/Name&gt;&lt;/FeatureType&gt;</code> from the XML web content as the data will be used for our next step.</p>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-param.png" alt="XML Web Content">
            <p>From there, we can proceed using the data to be used inside the URL <code>http://192.168.21.127/geoserver/ows?service=wfs&version=1.0.0&request=GetFeature&typeName=data&maxFeatures=1&outputFormat=json</code>.</p>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-json.png" alt="JSON Output">
            <p>From the JSON output above, we need to take note of the variable <code>properties:</code> inside <code>features:</code>. Using all the data above, we can craft our final payload, and we will be using CQL_FILTER of <code>strEndsWith</code> and <code>current_user</code> for the SQL Injection part such as <code>http://192.168.21.127/geoserver/ows?service=wfs&version=1.0.0&request=GetFeature&typeName=sf:archsites&CQL_FILTER=strEndsWith(cat,'x'')+=+true+and+1=(SELECT+CAST+((SELECT+current_user)+AS+INTEGER))+--+')+=+true</code>.</p>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-output.png" alt="Final Payload">
            <p>To make this process easier, we have developed a Golang script to recreate proof of concept for this vulnerability.</p>
            <img src="/images/CVE-2023-25157/CVE-2023-25157-poc.png" alt="Golang Script"><p></p>

            <h3>Solution</h3>
            <p>Upgrading to version 2.21.4 or 2.22.2 eliminates this issue. The most ideal mitigation is to upgrade to the latest version.</p>
            <p><strong>Source:</strong> <a href="https://github.com/geoserver/geoserver/commit/145a8af798590288d270b240235e89c8f0b62e1d" target="_blank">https://github.com/geoserver/geoserver/commit/145a8af798590288d270b240235e89c8f0b62e1d</a></p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<body>

    
</body>
</html>
